<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Galaxia para ti - Aniversario üíõ</title>
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial}
    #galaxy-canvas{position:fixed;inset:0;width:100%;height:100%;display:block;touch-action:none}
    .attribution{position:fixed;left:10px;bottom:10px;font-size:11px;color:#b9a0ff;opacity:.8;background:rgba(0,0,0,.35);padding:6px 8px;border-radius:8px;z-index:5}
    .player{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);display:flex;gap:8px;align-items:center;flex-wrap:wrap;
             background:rgba(20,15,35,.45);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 14px;
             backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);color:#fff;z-index:10;max-width:90%}
    .player button{padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);color:#fff;cursor:pointer;transition:all .2s;font-size:14px}
    .player button:hover{background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.4);transform:scale(1.05)}
    .player button:active{transform:scale(0.95)}
    .player input[type=file]{display:none}
    .player-info{flex:1;min-width:150px;font-size:13px;opacity:.95;text-align:center}
    .pill{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:999px;
          background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);color:#fff;font-size:14px;font-weight:600;z-index:5;
          backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);text-align:center;max-width:90%}
    .error{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#260015;color:#ffd9f7;border:1px solid #ff8ae5;border-radius:10px;padding:12px;font-size:12px;display:none;z-index:15;text-align:center;max-width:80%}
    .instructions{position:fixed;top:70px;left:10px;background:rgba(20,15,35,.45);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:12px;color:#fff;font-size:11px;max-width:220px;z-index:10;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
    .instructions ul{margin:6px 0;padding-left:18px}
    .instructions li{margin:5px 0;line-height:1.4}
    .start-overlay{position:fixed;inset:0;background:rgba(0,0,10,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(10px);padding:20px}
    .start-btn{padding:20px 40px;font-size:20px;font-weight:700;background:linear-gradient(135deg,#ff6ec7,#a855f7);border:none;border-radius:16px;color:#fff;cursor:pointer;box-shadow:0 8px 32px rgba(168,85,247,.4);transition:all .3s;margin-top:20px}
    .start-btn:hover{transform:scale(1.05);box-shadow:0 12px 48px rgba(168,85,247,.6)}
    .start-btn:active{transform:scale(0.95)}
    .start-text{color:#fff;font-size:18px;margin-bottom:20px;text-align:center;text-shadow:0 2px 10px rgba(255,255,255,.3)}
    
    @media (max-width: 768px) {
      .pill{font-size:12px;padding:8px 16px;top:8px}
      .instructions{font-size:10px;max-width:180px;padding:10px;top:60px}
      .player{font-size:12px;padding:8px 10px;bottom:8px;gap:6px}
      .player button{padding:8px 12px;font-size:13px}
      .player-info{font-size:11px;min-width:120px}
      .attribution{font-size:9px;padding:4px 6px}
      .start-btn{padding:16px 32px;font-size:18px}
      .start-text{font-size:16px}
    }
    @media (max-width: 480px) {
      .pill{font-size:11px;padding:6px 12px}
      .instructions{display:none}
      .player{flex-direction:column;padding:8px;gap:6px}
      .player button{width:100%;padding:10px}
      .start-btn{padding:14px 28px;font-size:16px}
      .start-text{font-size:16px;padding:0 20px;line-height:1.5}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

<div id="startOverlay" class="start-overlay">
  <div class="start-text">
    <div style="font-size:24px;margin-bottom:15px">üíõ‚ú®</div>
    <div style="font-size:18px;line-height:1.6;max-width:500px;margin:0 auto">
      En cada estrella de esta galaxia<br>
      vive un momento nuestro,<br>
      un suspiro, una risa, un te amo...<br><br>
      <strong>Esta galaxia es para ti, mi amor</strong>
    </div>
    <div style="font-size:24px;margin-top:15px">‚ú®üíõ</div>
  </div>
  <button class="start-btn" id="startBtn">‚ú® Abrir Mi Coraz√≥n ‚ú®</button>
</div>

<canvas id="galaxy-canvas"></canvas>
<div class="pill">üíõ Cada estrella aqu√≠ es un "Te Amo" para ti üíõ</div>
<div class="attribution">Hecho con todo mi amor para ti, mi Pinchecha Hermosa üí´</div>
<div id="err" class="error"></div>

<div class="instructions">
  <strong>‚ú® Instrucciones:</strong>
  <ul>
    <li>üñ±Ô∏è Arrastra para rotar</li>
    <li>üîç Scroll para zoom</li>
    <li>üíó Doble clic = corazones</li>
    <li>üéµ M√∫sica autom√°tica</li>
  </ul>
</div>

<div class="player">
  <button id="playBtn">‚è∏Ô∏é Pausar</button>
  <div class="player-info">
    <div><strong>üéµ M√∫sica del Coraz√≥n</strong></div>
  </div>
  <input type="file" id="pickFile" accept="audio/*">
  <button id="pickBtn">Cambiar Canci√≥n</button>
  <audio id="audio" preload="auto" loop>
    <source src="golden_hour.mp3" type="audio/mpeg">
  </audio>
</div>

<canvas id="fx" style="position:fixed;inset:0;pointer-events:none;z-index:2"></canvas>

<script>
(function(){
'use strict';

// ====== üì∏ CONFIGURA TUS FOTOS AQU√ç ======
// Puedes usar URLs de internet o rutas locales
const myPhotos = [
  // Descomenta estas l√≠neas y pon tus fotos:
  'img/amor1.jpg',
  'img/amor2.jpg',
  'img/amor3.jpg',
  'img/amor4.jpg',
  'img/amor5.jpg',
  'img/amor6.jpg',
  'img/amor7.jpg',
  'img/amor8.jpg',
  'img/amor9.jpg',
  'img/amor11.jpg',
  'img/amor13.jpg',
  'img/amor14.jpg',
  'img/amor15.jpg',
  'img/amor16.jpg',
  'img/amor17.jpg',
  // 'https://i.imgur.com/ejemplo.jpg',
];

const err = document.getElementById('err');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');

function showError(msg){ 
  err.textContent = msg; 
  err.style.display='block'; 
  setTimeout(()=>err.style.display='none', 4000); 
}

// ====== AUDIO ======
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
const pickBtn = document.getElementById('pickBtn');
const pickFile = document.getElementById('pickFile');

// Bot√≥n de inicio - Reproduce m√∫sica autom√°ticamente
startBtn.addEventListener('click', async function() {
  startOverlay.style.display = 'none';
  // Intentar reproducir m√∫sica autom√°ticamente
  try {
    await audio.play();
    playBtn.textContent = '‚è∏Ô∏é Pausar';
  } catch(e) {
    // Si falla el autoplay, intenta de nuevo despu√©s de un momento
    setTimeout(async () => {
      try {
        await audio.play();
        playBtn.textContent = '‚è∏Ô∏é Pausar';
      } catch(err) {
        playBtn.textContent = '‚ñ∂Ô∏é Reproducir';
      }
    }, 100);
  }
});

playBtn.onclick = async () => {
  try { 
    if (audio.paused) { 
      await audio.play(); 
      playBtn.textContent='‚è∏Ô∏é Pausar'; 
    } else { 
      audio.pause(); 
      playBtn.textContent='‚ñ∂Ô∏é Reproducir'; 
    }
  } catch(e){ 
    showError('Error al reproducir m√∫sica'); 
  }
};

pickBtn.onclick = () => pickFile.click();
pickFile.onchange = () => {
  if (pickFile.files && pickFile.files[0]) {
    const url = URL.createObjectURL(pickFile.files[0]);
    audio.src = url; 
    audio.play().then(()=> playBtn.textContent='‚è∏Ô∏é Pausar').catch(()=>{});
  }
};

// ====== WEBGL CHECK ======
try { 
  const test = document.createElement('canvas').getContext('webgl');
  if(!test) throw new Error('WebGL no disponible');
} catch(e) { 
  showError('WebGL desactivado. Prueba con Chrome/Firefox.'); 
  return; 
}

// ====== THREE.JS GALAXY ======
const canvas = document.getElementById('galaxy-canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false });
renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
renderer.setSize(window.innerWidth, window.innerHeight);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; 
controls.dampingFactor = 0.06;
controls.minDistance = 10; 
controls.maxDistance = 220;

function setCam(){
  const w = window.innerWidth, h = window.innerHeight;
  const isMobile = w < 768 || w < h;
  camera.fov = isMobile ? 95 : 75;
  camera.position.set(0, isMobile ? 30 : 24, isMobile ? 120 : 80);
  camera.updateProjectionMatrix(); 
  controls.update();
} 
setCam();

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  setCam();
});

// ====== STARFIELD ======
function makePrettyStarTexture(size=1024, count=3000) {
  const c = document.createElement('canvas'); 
  c.width = c.height = size;
  const g = c.getContext('2d');
  const r = size/2;
  const bg = g.createRadialGradient(r,r, r*0.1, r,r, r);
  bg.addColorStop(0,'#0a0015');
  bg.addColorStop(0.5,'#050010');
  bg.addColorStop(1,'#000000');
  g.fillStyle = bg; 
  g.fillRect(0,0,size,size);

  // Nebulas
  for(let i=0; i<8; i++) {
    const nx = Math.random()*size;
    const ny = Math.random()*size;
    const nr = Math.random()*size*0.3 + size*0.2;
    const nebula = g.createRadialGradient(nx,ny,0, nx,ny,nr);
    const hue = Math.random() < 0.5 ? 'rgba(180,100,255,' : 'rgba(255,120,200,';
    nebula.addColorStop(0, hue+'0.08)');
    nebula.addColorStop(0.5, hue+'0.03)');
    nebula.addColorStop(1, 'rgba(0,0,0,0)');
    g.fillStyle = nebula;
    g.fillRect(0,0,size,size);
  }

  // Stars
  for (let i=0;i<count;i++) {
    const x = Math.random()*size, y = Math.random()*size;
    const base = Math.random()*0.8 + 0.2;
    const glowSize = Math.random()*2.5 + 1.2;
    const glow = g.createRadialGradient(x,y,0, x,y, glowSize);
    const huePick = Math.random();
    let colInner = 'rgba(255,255,255,'+(0.7*base)+')';
    let colOuter = 'rgba(200,210,255,'+(0.15*base)+')';
    if (huePick < 0.3) colOuter = 'rgba(255,200,240,'+(0.15*base)+')';
    else if (huePick < 0.5) colOuter = 'rgba(200,255,255,'+(0.15*base)+')';
    glow.addColorStop(0, colInner);
    glow.addColorStop(1, colOuter);
    g.fillStyle = glow; 
    g.beginPath(); 
    g.arc(x,y, Math.random()*1.3+0.5, 0, Math.PI*2); 
    g.fill();
  }
  return new THREE.CanvasTexture(c);
}

const bgGeo = new THREE.SphereGeometry(600, 64, 64);
const starTex = makePrettyStarTexture(1024, 3500);
starTex.wrapS = starTex.wrapT = THREE.RepeatWrapping;
const bg = new THREE.Mesh(bgGeo, new THREE.MeshBasicMaterial({ 
  map: starTex, 
  side: THREE.BackSide, 
  transparent:false, 
  opacity:0.9 
}));
scene.add(bg);

// ====== GALAXY GROUP ======
const galaxy = new THREE.Group(); 
scene.add(galaxy);

const phrases = [
  "Pinchecha ‚ú®", "Hermosa üíõ", "Mi Bebe üë∂", "Mi Cielito üåå", 
  "Hermosota ‚ú®", "Mi Infinita ‚ôæÔ∏è", "Mi Todo üí´", "Me Encantas ü•∞", 
  "Andrea üí´", "Te Amo üíõ", "Mi Canci√≥n üé∂", "√önica üòä", 
  "Mi Reina üëë", "Mi Amor ‚ù§Ô∏è", "Mi Mundo üåç", "Mi Luz üå†", 
  "Mi Ni√±a üéÄ", "Mi Tesoro üíõ", "Mi Paz ‚òÆÔ∏è", "Mi Eterna ‚ôæÔ∏è", 
  "Mi Sue√±o üí≠", "Mi Favorita ‚≠ê", "Mi Bomb√≥n üç¨", "Mi Diosa üë∏", 
  "Te Amo Infinitamente ‚ôæÔ∏è", "Mi Vida üí´", "Perfecta üåü"
];

function makeTextTexture(text, size=48){
  const c=document.createElement('canvas'); 
  c.width=1024; 
  c.height=128;
  const g=c.getContext('2d'); 
  g.clearRect(0,0,c.width,c.height);
  g.font='800 '+size+'px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial';
  g.textAlign='center'; 
  g.textBaseline='middle';
  g.shadowColor='rgba(220,150,255,0.95)'; 
  g.shadowBlur=26;
  g.fillStyle='rgba(255,245,255,0.98)'; 
  g.fillText(text,c.width/2,c.height/2);
  return new THREE.CanvasTexture(c);
}

function makePhotoTexture(img) {
  const maxSize = 512;
  const c = document.createElement('canvas');
  const aspect = img.width / img.height;
  
  if (aspect > 1) {
    c.width = maxSize;
    c.height = maxSize / aspect;
  } else {
    c.height = maxSize;
    c.width = maxSize * aspect;
  }
  
  const g = c.getContext('2d');
  g.drawImage(img, 0, 0, c.width, c.height);
  
  // Marco sutil
  g.strokeStyle = 'rgba(255,255,255,0.4)';
  g.lineWidth = 4;
  g.strokeRect(2, 2, c.width-4, c.height-4);
  
  return new THREE.CanvasTexture(c);
}

// Cargar fotos
if (myPhotos.length > 0) {
  myPhotos.forEach((photoSrc, index) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    
    img.onload = function() {
      const tex = makePhotoTexture(img);
      const spr = new THREE.Sprite(new THREE.SpriteMaterial({ 
        map: tex, 
        transparent: true, 
        depthWrite: false 
      }));
      
      const totalPhotos = myPhotos.length;
      const armIndex = index % 5;
      const distFactor = index / totalPhotos;
      const angle = (index / totalPhotos) * Math.PI * 4 + (armIndex * Math.PI * 2 / 5);
      const dist = (1 - Math.pow(distFactor, 0.8)) * 70 + 15;
      const height = (Math.random() - 0.5) * 18 * (1 - distFactor);
      
      spr.position.set(
        Math.cos(angle) * dist,
        height,
        Math.sin(angle) * dist
      );
      
      const aspect = img.width / img.height;
      const baseSize = 14;
      if (aspect > 1) {
        spr.scale.set(baseSize * aspect, baseSize, 1);
      } else {
        spr.scale.set(baseSize, baseSize / aspect, 1);
      }
      
      galaxy.add(spr);
    };
    
    img.onerror = function() {
      console.error('Error cargando foto:', photoSrc);
    };
    
    img.src = photoSrc;
  });
}

// Frases en espiral
const arms = 5;
const radius = 82;
const maxH = 22;
const phraseCount = phrases.length * 7;

for(let i=0; i<phraseCount; i++) { 
  const text = phrases[i % phrases.length];
  const tex = makeTextTexture(text, 48);
  const spr = new THREE.Sprite(new THREE.SpriteMaterial({ 
    map: tex, 
    transparent: true, 
    depthWrite: false 
  }));
  
  const perArm = phraseCount / arms;
  const ang = (i % perArm) * (Math.PI * 2 / perArm);
  const armAng = Math.floor(i / perArm) * (Math.PI * 2 / arms);
  const dist = Math.pow(i / phraseCount, 0.7) * radius;
  const thickness = Math.pow(1 - (dist / radius), 2);
  
  const x = Math.cos(ang + armAng) * dist;
  const z = Math.sin(ang + armAng) * dist;
  const y = (Math.random() - 0.5) * maxH * thickness * 0.85;
  
  spr.position.set(x, y, z); 
  spr.scale.set(20, 2.6, 1); 
  galaxy.add(spr);
}

// ====== PARTICLE STARS ======
const starCount = 10000;
const geom = new THREE.BufferGeometry();
const pos = new Float32Array(starCount * 3);
const colors = new Float32Array(starCount * 3);

for(let i=0; i<starCount; i++) { 
  const ang = Math.random() * Math.PI * 2;
  const dist = Math.random() * radius * 1.2;
  const y = (Math.random() - 0.5) * 38 * Math.pow(1 - Math.min(dist, radius) / radius, 1.4);
  
  pos[i*3] = Math.cos(ang) * dist;
  pos[i*3+1] = y;
  pos[i*3+2] = Math.sin(ang) * dist;
  
  const colorChoice = Math.random();
  if (colorChoice < 0.7) {
    colors[i*3] = 1;
    colors[i*3+1] = 1;
    colors[i*3+2] = 1;
  } else if (colorChoice < 0.85) {
    colors[i*3] = 1;
    colors[i*3+1] = 0.8;
    colors[i*3+2] = 1;
  } else {
    colors[i*3] = 0.8;
    colors[i*3+1] = 0.9;
    colors[i*3+2] = 1;
  }
}

geom.setAttribute('position', new THREE.BufferAttribute(pos, 3));
geom.setAttribute('color', new THREE.BufferAttribute(colors, 3));

galaxy.add(new THREE.Points(geom, new THREE.PointsMaterial({ 
  size: 0.32, 
  transparent: true, 
  opacity: 0.7, 
  vertexColors: true,
  blending: THREE.AdditiveBlending 
})));

// ====== BLACK HOLE ======
const coreR = 12;
const coreTexCanvas = document.createElement('canvas');
coreTexCanvas.width = coreTexCanvas.height = 256;
const cg = coreTexCanvas.getContext('2d');
const grd = cg.createRadialGradient(128,128,10,128,128,128);
grd.addColorStop(0,'#1a0020');
grd.addColorStop(0.5,'#0d0018');
grd.addColorStop(1,'#000');
cg.fillStyle = grd;
cg.fillRect(0,0,256,256);

const core = new THREE.Mesh(
  new THREE.SphereGeometry(coreR, 64, 64), 
  new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(coreTexCanvas) })
);
core.renderOrder = 1;
scene.add(core);

const photonRing = new THREE.Mesh(
  new THREE.RingGeometry(coreR*1.05, coreR*1.2, 128), 
  new THREE.MeshBasicMaterial({ 
    color: 0xEAAEFF, 
    transparent: true, 
    opacity: 0.95, 
    side: THREE.DoubleSide 
  })
);
photonRing.rotation.x = -Math.PI/2;
photonRing.renderOrder = 0.5;
scene.add(photonRing);

function makeHaloTexture(size=1024, inner=0.42){
  const c = document.createElement('canvas');
  c.width = c.height = size;
  const g = c.getContext('2d');
  const r = size/2;
  const grd = g.createRadialGradient(r,r,r*inner, r,r,r);
  grd.addColorStop(0.0,'rgba(255,210,245,0.5)');
  grd.addColorStop(0.3,'rgba(230,190,255,0.4)');
  grd.addColorStop(0.6,'rgba(180,210,255,0.3)');
  grd.addColorStop(1,'rgba(0,0,0,0)');
  g.fillStyle = grd;
  g.fillRect(0,0,size,size);
  return new THREE.CanvasTexture(c);
}

const haloPlane = new THREE.Mesh(
  new THREE.PlaneGeometry(340, 340), 
  new THREE.MeshBasicMaterial({ 
    map: makeHaloTexture(1024, 0.42), 
    transparent: true, 
    depthWrite: false, 
    blending: THREE.AdditiveBlending, 
    opacity: 0.92 
  })
);
haloPlane.rotation.x = -Math.PI/2;
haloPlane.renderOrder = 0.2;
scene.add(haloPlane);

// ====== SHOOTING STARS ======
const shootingStars = [];
function createShootingStar() {
  const geo = new THREE.BufferGeometry();
  const positions = new Float32Array(60);
  geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  
  const mat = new THREE.LineBasicMaterial({ 
    color: 0xffffff, 
    transparent: true, 
    opacity: 0.8,
    blending: THREE.AdditiveBlending
  });
  
  const line = new THREE.Line(geo, mat);
  
  const angle = Math.random() * Math.PI * 2;
  const dist = 150 + Math.random() * 100;
  line.position.set(
    Math.cos(angle) * dist,
    40 + Math.random() * 60,
    Math.sin(angle) * dist
  );
  
  const targetAngle = angle + Math.PI;
  line.velocity = new THREE.Vector3(
    Math.cos(targetAngle) * (2 + Math.random() * 2),
    -1 - Math.random(),
    Math.sin(targetAngle) * (2 + Math.random() * 2)
  );
  
  line.life = 1;
  scene.add(line);
  shootingStars.push(line);
}

setInterval(() => {
  if (Math.random() < 0.3) createShootingStar();
}, 3000);

// ====== ANIMATION ======
let tw = 0;
function animate() {
  requestAnimationFrame(animate);
  const t = performance.now() * 0.001;
  
  tw = (tw + 0.0004) % 1;
  starTex.offset.set(tw * 0.5, tw * 0.3);
  
  galaxy.rotation.y = t * 0.045;
  
  core.rotation.y = t * 0.15;
  photonRing.rotation.z = t * 0.2;
  haloPlane.rotation.z = t * 0.025;
  
  for(let i = shootingStars.length - 1; i >= 0; i--) {
    const star = shootingStars[i];
    star.position.add(star.velocity);
    star.life -= 0.008;
    star.material.opacity = star.life * 0.8;
    
    const positions = star.geometry.attributes.position.array;
    for(let j = positions.length - 3; j > 0; j -= 3) {
      positions[j] = positions[j-3];
      positions[j+1] = positions[j-2];
      positions[j+2] = positions[j-1];
    }
    positions[0] = 0;
    positions[1] = 0;
    positions[2] = 0;
    star.geometry.attributes.position.needsUpdate = true;
    
    if (star.life <= 0) {
      scene.remove(star);
      shootingStars.splice(i, 1);
    }
  }
  
  controls.update();
  renderer.render(scene, camera);
}
animate();

// ====== HEARTS OVERLAY ======
const fx = document.getElementById('fx');
const ctx2 = fx.getContext('2d');

function resizeFx(){
  fx.width = Math.floor(innerWidth * Math.min(2, window.devicePixelRatio||1));
  fx.height = Math.floor(innerHeight * Math.min(2, window.devicePixelRatio||1));
  fx.style.width = innerWidth + 'px';
  fx.style.height = innerHeight + 'px';
}
window.addEventListener('resize', resizeFx);
resizeFx();

const DPR = Math.min(2, window.devicePixelRatio || 1);
const hearts = [];

function spawnHearts(x, y, n=25) {
  x *= DPR;
  y *= DPR;
  for(let i=0; i<n; i++) {
    const a = Math.random() * Math.PI * 2;
    hearts.push({
      x, y,
      vx: Math.cos(a) * (0.8 + Math.random() * 1),
      vy: -(1 + Math.random() * 1.4),
      life: 1,
      size: 12 + Math.random() * 20
    });
  }
}

function drawHeart(x, y, size) {
  const s = size;
  ctx2.save();
  ctx2.translate(x, y);
  ctx2.beginPath();
  ctx2.moveTo(0, -0.25*s);
  ctx2.bezierCurveTo(.5*s, -.9*s, 1.4*s, -.1*s, 0, .9*s);
  ctx2.bezierCurveTo(-1.4*s, -.1*s, -.5*s, -.9*s, 0, -.25*s);
  const g = ctx2.createRadialGradient(0, 0, 0, 0, 0, s);
  g.addColorStop(0, 'rgba(255,200,230,.95)');
  g.addColorStop(1, 'rgba(255,100,180,0)');
  ctx2.fillStyle = g;
  ctx2.fill();
  ctx2.restore();
}

let lastTap = 0;
window.addEventListener('click', (e) => {
  const now = performance.now();
  if (now - lastTap < 350) spawnHearts(e.clientX, e.clientY, 25);
  lastTap = now;
}, {passive: true});

window.addEventListener('touchend', (e) => {
  const now = performance.now();
  const t = e.changedTouches && e.changedTouches[0];
  if (now - lastTap < 350 && t) spawnHearts(t.clientX, t.clientY, 25);
  lastTap = now;
}, {passive: true});

function loopFx() {
  ctx2.clearRect(0, 0, fx.width, fx.height);
  for(let i = hearts.length - 1; i >= 0; i--) {
    const h = hearts[i];
    h.x += h.vx;
    h.y += h.vy;
    h.vy -= 0.025;
    h.life -= 0.012;
    ctx2.globalAlpha = Math.max(0, h.life);
    drawHeart(h.x, h.y, h.size);
    ctx2.globalAlpha = 1;
    if (h.life <= 0) hearts.splice(i, 1);
  }
  requestAnimationFrame(loopFx);
}
loopFx();

})();
</script>
</body>
</html>